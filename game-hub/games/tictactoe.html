<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ticâ€‘Tacâ€‘Toe</title>
  <link rel="stylesheet" href="games.css" />
  <style>
    .board{display:grid; grid-template-columns:repeat(3,100px); gap:8px; margin-top:16px}
    .cell{
        width:100px; height:100px; display:grid; place-items:center; font-size:42px;
        border:1px solid var(--border); border-radius:12px; background:var(--card); cursor:pointer;
        transition: transform .2s ease, background-color .2s ease; /* Added */
    }
    /* Added: animation for placing a mark */
    .cell > span {
        display: block;
        animation: popIn .3s ease-out;
    }
    .cell.win{
        background-color: rgba(124,92,255,.2); /* Modified */
        animation: pulse .6s ease-out 3; /* Added: pulse effect */
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="../index.html">â† Back to Hub</a>
    <strong>âŒâ­• Ticâ€‘Tacâ€‘Toe</strong>
    <button id="themeToggle" class="theme" aria-label="Toggle theme">ğŸŒ™</button>
  </header>
  <main class="container">
    <div class="controls">
      <label><input type="checkbox" id="cpuToggle" /> Play vs CPU</label>
      <button id="reset">Reset</button>
      <span id="turn" class="meta">Turn: X</span>
    </div>
    <div class="board" id="board"></div>
    <p id="status" class="meta"></p>
  </main>

  <script>
    const root=document.documentElement;const themeBtn=document.getElementById('themeToggle');
    const saved=localStorage.getItem('theme'); if(saved==='light') root.classList.add('light');
    themeBtn.textContent=root.classList.contains('light')?'ğŸŒ':'ğŸŒ™';
    themeBtn.addEventListener('click',()=>{root.classList.toggle('light'); localStorage.setItem('theme',root.classList.contains('light')?'light':'dark'); themeBtn.textContent=root.classList.contains('light')?'ğŸŒ':'ğŸŒ™';});

    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');
    const turnEl = document.getElementById('turn');
    const resetBtn = document.getElementById('reset');
    const cpuToggle = document.getElementById('cpuToggle');

    let cells = Array(9).fill('');
    let turn = 'X';
    let gameOver = false;

    function draw(){
      boardEl.innerHTML='';
      cells.forEach((val,idx)=>{
        const d=document.createElement('button'); d.className='cell'; d.dataset.idx=idx;
        // Modified: Wrap text in a span for animation
        if (val) {
            const span = document.createElement('span');
            span.textContent = val;
            d.appendChild(span);
        }
        boardEl.appendChild(d);
      });
    }
    function lines(){return [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]}
    function winner(){
      for(const [a,b,c] of lines()){
        if(cells[a] && cells[a]===cells[b] && cells[a]===cells[c]) return [cells[a],[a,b,c]];
      }
      if(cells.every(Boolean)) return ['Draw',[]];
      return null;
    }
    function highlight(indices){
      indices.forEach(i=> boardEl.children[i].classList.add('win'));
    }

    function play(idx){
      if(gameOver || cells[idx]) return;
      cells[idx]=turn;
      
      // Modified: Only re-render the single changed cell for animation
      const cellEl = boardEl.children[idx];
      const span = document.createElement('span');
      span.textContent = turn;
      cellEl.innerHTML = '';
      cellEl.appendChild(span);

      const w = winner();
      if(w){
        gameOver=true;
        if(w[0]==='Draw'){ statusEl.textContent='It\'s a draw.'; }
        else { statusEl.textContent = w[0]+' wins!'; highlight(w[1]); saveStats(w[0]); }
        return;
      }
      turn = turn==='X'?'O':'X'; turnEl.textContent='Turn: '+turn;
      if(cpuToggle.checked && turn==='O'){
          setTimeout(cpuMove, 300); // Added slight delay for CPU move
      }
    }

    function cpuMove(){
      const empty = cells.map((v,i)=> v?null:i).filter(v=>v!==null);
      const tryLines = (mark)=>{
        for(const [a,b,c] of lines()){
          const line=[cells[a],cells[b],cells[c]];
          if(line.filter(v=>v===mark).length===2 && line.includes('')){
            const i=[a,b,c][line.indexOf('')]; return i;
          }
        }
        return null;
      };
      let move = tryLines('O');
      if(move===null) move = tryLines('X');
      if(move===null) move = empty[Math.floor(Math.random()*empty.length)];
      play(move);
    }

    function saveStats(winner){
      if(!cpuToggle.checked) return;
      if(winner==='X'){
        localStorage.setItem('ttt_wins', String((parseInt(localStorage.getItem('ttt_wins')||'0',10))+1));
      } else if(winner==='O'){
        localStorage.setItem('ttt_losses', String((parseInt(localStorage.getItem('ttt_losses')||'0',10))+1));
      }
    }

    boardEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.cell'); if(!btn) return; play(parseInt(btn.dataset.idx,10));
    });
    
    // Modified reset to use the initial draw function
    resetBtn.addEventListener('click',()=>{ cells=Array(9).fill(''); turn='X'; gameOver=false; statusEl.textContent=''; turnEl.textContent='Turn: X'; boardEl.innerHTML = ''; createBoard(); });

    // Added: Function to create the initial empty board
    function createBoard() {
        cells.forEach((_, idx) => {
            const d = document.createElement('button');
            d.className = 'cell';
            d.dataset.idx = idx;
            boardEl.appendChild(d);
        });
    }
    createBoard();
  </script>
</body>
</html>